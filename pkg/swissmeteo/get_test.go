/*
Sunly
Copyright (C) 2023 Dario Mader

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/

package swissmeteo

import (
	"bytes"
	"io/ioutil"
	"net/http"
	"testing"
)

func TestGetWeatherData(t *testing.T) {
	// Create a new instance of the Weather struct
	w := &Weather{}

	// Mock the HTTP response
	response := `
	{
		"currentWeather": {
		  "time": 1683452400000,
		  "icon": 35,
		  "iconV2": 35,
		  "temperature": 17
		},
		"forecast": [
		  {
			"dayDate": "2023-05-07",
			"iconDay": 25,
			"iconDayV2": 25,
			"temperatureMax": 18,
			"temperatureMin": 11,
			"precipitation": 12.7
		  },
		  {
			"dayDate": "2023-05-08",
			"iconDay": 4,
			"iconDayV2": 4,
			"temperatureMax": 19,
			"temperatureMin": 11,
			"precipitation": 4.7
		  },
		  {
			"dayDate": "2023-05-09",
			"iconDay": 17,
			"iconDayV2": 17,
			"temperatureMax": 19,
			"temperatureMin": 10,
			"precipitation": 10.4
		  },
		  {
			"dayDate": "2023-05-10",
			"iconDay": 3,
			"iconDayV2": 3,
			"temperatureMax": 16,
			"temperatureMin": 9,
			"precipitation": 3.4
		  },
		  {
			"dayDate": "2023-05-11",
			"iconDay": 14,
			"iconDayV2": 14,
			"temperatureMax": 15,
			"temperatureMin": 7,
			"precipitation": 6.8
		  },
		  {
			"dayDate": "2023-05-12",
			"iconDay": 14,
			"iconDayV2": 14,
			"temperatureMax": 15,
			"temperatureMin": 8,
			"precipitation": 6.7
		  }
		],
		"warnings": [
		  {
			"warnType": 2,
			"warnLevel": 2,
			"text": "- Expected amounts: 20-40 mm\n- Snowfall limit: 2700-2300 m (sinking)",
			"validFrom": 1683464400000,
			"validTo": 1683518400000,
			"ordering": "a4c1683464400000",
			"htmlText": "<b>- Expected amounts: </b>20-40 mm<br><b>- Snowfall limit: </b>2700-2300 m (sinking)",
			"links": [
			  {
				"url": "https://www.natural-hazards.ch/home/dealing-with-natural-hazards/rain.html?utm_source=app&utm_medium=referral&utm_campaign=warning#during-rain",
				"text": "General recommendations"
			  },
			  {
				"url": "https://www.meteoswiss.admin.ch/home/weather/hazards.html",
				"text": "Â© MeteoSwiss"
			  }
			],
			"outlook": false
		  }
		],
		"warningsOverview": [
		  {
			"warnType": 2,
			"warnLevel": 2
		  }
		],
		"graph": {
		  "start": 1683410400000,
		  "startLowResolution": 1683468000000,
		  "precipitation10m": [
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0.1,
			0.1,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0.1,
			0.2,
			0.1,
			0.1,
			0.1,
			0,
			0,
			0,
			0.1,
			0.8,
			1.7,
			1,
			1.8,
			1.8,
			2.2,
			3.6,
			4,
			2.6,
			4.8,
			2.8,
			2,
			2
		  ],
		  "precipitationMin10m": [
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0.1,
			0,
			0,
			0,
			0,
			0.5,
			0.6,
			1.1,
			2.3,
			1.2,
			0.8,
			0.7
		  ],
		  "precipitationMax10m": [
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0.1,
			0.1,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0.1,
			0.1,
			0.1,
			0.1,
			0.1,
			0.1,
			0.7,
			0.8,
			0.9,
			0.8,
			0.8,
			0.8,
			2.3,
			2.3,
			2.3,
			2.5,
			3.7,
			4.9,
			1.6,
			2.4,
			2.5,
			2.9,
			4.4,
			4.8,
			4.3,
			6.6,
			4.5,
			3.6,
			3.6
		  ],
		  "weatherIcon3h": [
			126,
			126,
			3,
			4,
			23,
			25,
			20,
			114,
			105,
			105,
			5,
			5,
			3,
			3,
			3,
			103,
			103,
			135,
			35,
			35,
			5,
			17,
			17,
			117,
			114,
			114,
			5,
			3,
			3,
			3,
			35,
			103,
			135,
			103,
			4,
			5,
			14,
			14,
			14,
			114,
			114,
			114,
			14,
			14,
			14,
			6,
			6,
			106
		  ],
		  "weatherIcon3hV2": [
			126,
			126,
			3,
			4,
			23,
			25,
			20,
			114,
			105,
			105,
			5,
			5,
			3,
			3,
			3,
			103,
			103,
			135,
			35,
			35,
			5,
			17,
			17,
			117,
			114,
			114,
			5,
			3,
			3,
			3,
			35,
			103,
			135,
			103,
			4,
			5,
			14,
			14,
			14,
			114,
			114,
			114,
			14,
			14,
			14,
			6,
			6,
			106
		  ],
		  "windDirection3h": [
			83,
			120,
			146,
			175,
			151,
			222,
			244,
			176,
			112,
			84,
			94,
			125,
			128,
			356,
			32,
			70,
			76,
			83,
			73,
			129,
			249,
			260,
			259,
			242,
			247,
			256,
			256,
			252,
			254,
			259,
			263,
			265,
			57,
			359,
			50,
			327,
			22,
			2,
			11,
			19,
			31,
			8,
			13,
			33,
			39,
			26,
			19,
			26
		  ],
		  "windSpeed3h": [
			10.6,
			8.1,
			4.5,
			5.5,
			5.1,
			6.4,
			8.2,
			6.1,
			3.5,
			3,
			2.6,
			3.6,
			6.2,
			6.4,
			6.4,
			3.2,
			2.9,
			2.8,
			2.9,
			3.9,
			6.6,
			8.3,
			8,
			6.6,
			8.4,
			8.1,
			7,
			9.7,
			10.6,
			12.2,
			10,
			4.5,
			3.1,
			2.3,
			2.6,
			4.2,
			6.6,
			8.3,
			6.8,
			3.8,
			3.5,
			3.5,
			3.8,
			7.2,
			9.3,
			11.4,
			8.8,
			6.9
		  ],
		  "sunrise": [
			1683432367173,
			1683518680496,
			1683604995375,
			1683691311848,
			1683777629964,
			1683863949765
		  ],
		  "sunset": [
			1683485287269,
			1683571766118,
			1683658244543,
			1683744722510,
			1683831199981,
			1683917676916
		  ],
		  "temperatureMin1h": [
			14.1,
			13.7,
			13.3,
			12.6,
			11.9,
			11.2,
			11.1,
			11.2,
			11.8,
			13.3,
			14.8,
			15.9,
			16.4,
			16.4,
			16.8,
			16.8,
			16.6,
			16.1,
			15.5,
			14.9,
			14,
			13.2,
			12.4,
			11.8,
			11.3,
			10.9,
			10.5,
			10.3,
			10.2,
			10.3,
			10.4,
			10.8,
			11.4,
			12.1,
			13,
			13.9,
			14.8,
			15.7,
			16.4,
			17,
			17.3,
			17.3,
			17,
			16.3,
			15.4,
			14.3,
			13.2,
			12.1,
			11.1,
			10.2,
			9.5,
			8.9,
			8.6,
			8.7,
			9.1,
			9.9,
			11,
			12.4,
			13.9,
			15.2,
			16.2,
			16.7,
			16.8,
			16.5,
			15.9,
			15.2,
			14.4,
			13.7,
			13,
			12.5,
			11.9,
			11.4,
			11,
			10.5,
			10.1,
			9.7,
			9.4,
			9.2,
			9.2,
			9.4,
			9.9,
			10.6,
			11.3,
			12.1,
			12.8,
			13.4,
			13.9,
			14.2,
			14.2,
			14,
			13.5,
			12.8,
			11.9,
			10.9,
			9.9,
			9,
			8.1,
			7.5,
			6.9,
			6.4,
			6.2,
			6.2,
			6.5,
			7.1,
			8.1,
			9.2,
			10.5,
			11.8,
			12.8,
			13.5,
			13.9,
			14,
			13.8,
			13.4,
			12.7,
			11.9,
			11,
			10.1,
			9.3,
			8.6,
			8,
			7.5,
			7,
			6.6,
			6.3,
			6.2,
			6.4,
			6.8,
			7.5,
			8.4,
			9.5,
			10.5,
			11.4,
			12.2,
			12.8,
			13.2,
			13.3,
			13.2,
			12.8,
			12.1,
			11.3,
			10.3,
			9.3,
			8.4
		  ],
		  "temperatureMax1h": [
			14.1,
			13.7,
			13.3,
			12.6,
			11.9,
			11.2,
			11.1,
			11.2,
			11.8,
			13.3,
			14.8,
			15.9,
			17.9,
			18.2,
			18.6,
			18.6,
			18.2,
			17.6,
			16.8,
			15.9,
			14.9,
			14,
			13.3,
			12.7,
			12.2,
			11.8,
			11.5,
			11.3,
			11.2,
			11.3,
			11.7,
			12.2,
			13.1,
			14.2,
			15.6,
			17,
			18.3,
			19.5,
			20.3,
			20.8,
			20.9,
			20.6,
			19.9,
			19,
			17.8,
			16.6,
			15.3,
			14.2,
			13.2,
			12.3,
			11.6,
			11,
			10.8,
			10.8,
			11.3,
			12.2,
			13.5,
			15.2,
			17,
			18.8,
			20.3,
			21.3,
			21.6,
			21.4,
			20.7,
			19.7,
			18.5,
			17.2,
			16,
			15,
			14.2,
			13.5,
			12.9,
			12.4,
			12,
			11.6,
			11.2,
			11,
			11.1,
			11.4,
			12,
			12.9,
			14,
			15,
			16,
			16.7,
			17.2,
			17.4,
			17.3,
			16.9,
			16.3,
			15.4,
			14.4,
			13.3,
			12.3,
			11.3,
			10.4,
			9.6,
			9,
			8.6,
			8.4,
			8.4,
			8.7,
			9.4,
			10.5,
			11.8,
			13.2,
			14.5,
			15.7,
			16.6,
			17.1,
			17.3,
			17.1,
			16.6,
			15.8,
			14.9,
			13.9,
			12.9,
			12,
			11.2,
			10.5,
			9.9,
			9.4,
			9,
			8.6,
			8.5,
			8.5,
			8.9,
			9.5,
			10.4,
			11.5,
			12.6,
			13.7,
			14.8,
			15.6,
			16.1,
			16.3,
			16.1,
			15.6,
			14.7,
			13.7,
			12.5,
			11.5,
			10.5
		  ],
		  "temperatureMean1h": [
			14.1,
			13.7,
			13.3,
			12.6,
			11.9,
			11.2,
			11.1,
			11.2,
			11.8,
			13.3,
			14.8,
			15.9,
			17,
			17.2,
			17.6,
			17.6,
			17.3,
			16.8,
			16.1,
			15.4,
			14.5,
			13.7,
			12.9,
			12.3,
			11.8,
			11.4,
			11.1,
			10.9,
			10.8,
			10.9,
			11.1,
			11.5,
			12.2,
			13.1,
			14.2,
			15.3,
			16.5,
			17.5,
			18.4,
			19.1,
			19.4,
			19.3,
			18.8,
			18,
			16.9,
			15.7,
			14.5,
			13.3,
			12.2,
			11.4,
			10.6,
			10.1,
			9.9,
			10,
			10.4,
			11.3,
			12.6,
			14.2,
			15.9,
			17.4,
			18.6,
			19.3,
			19.4,
			18.9,
			18.1,
			17.1,
			16,
			15,
			14.1,
			13.4,
			12.7,
			12.2,
			11.7,
			11.3,
			10.9,
			10.5,
			10.3,
			10.1,
			10.2,
			10.5,
			11.1,
			11.9,
			12.8,
			13.7,
			14.5,
			15.2,
			15.8,
			16.1,
			16.1,
			15.8,
			15.2,
			14.4,
			13.4,
			12.3,
			11.3,
			10.3,
			9.4,
			8.7,
			8.1,
			7.6,
			7.3,
			7.3,
			7.7,
			8.3,
			9.3,
			10.5,
			11.9,
			13.1,
			14.2,
			14.9,
			15.4,
			15.4,
			15.2,
			14.6,
			13.9,
			12.9,
			12,
			11,
			10.2,
			9.5,
			9,
			8.5,
			8.2,
			7.8,
			7.6,
			7.5,
			7.6,
			7.9,
			8.6,
			9.5,
			10.5,
			11.6,
			12.6,
			13.4,
			14.1,
			14.6,
			14.7,
			14.5,
			14,
			13.2,
			12.3,
			11.3,
			10.3,
			9.5
		  ],
		  "precipitation1h": [
			1.3,
			1.9,
			2.1,
			1.1,
			0.3,
			0.4,
			0.1,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0.1,
			0.1,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0.2,
			0.4,
			1.2,
			1.2,
			1.1,
			1,
			1.3,
			0.9,
			1.1,
			0.3,
			0.1,
			0,
			0.1,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0.1,
			0.3,
			0.4,
			0,
			0.2,
			0.4,
			0.3,
			0.2,
			0.2,
			0.2,
			0,
			0,
			0.1,
			0.2,
			0.2,
			0.2,
			0.2,
			0.2,
			0.2,
			0.2,
			0.2,
			0.2,
			0.2,
			0.2,
			0.2,
			0.3,
			0.3,
			0.3,
			0.4,
			0.4,
			0.4,
			0.2,
			0.2,
			0.2,
			0.1
		  ],
		  "precipitationMin1h": [
			0.9,
			1.6,
			1.2,
			0.1,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0.2,
			0.3,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0.1,
			0.1,
			0.1,
			0.1,
			0.1,
			0.1,
			0.1,
			0.1,
			0.1,
			0.1,
			0.1,
			0.1,
			0.1,
			0.1,
			0.1,
			0,
			0,
			0,
			0
		  ],
		  "precipitationMax1h": [
			2.9,
			4.5,
			3.6,
			2.6,
			2.5,
			2,
			0.5,
			0.4,
			0.3,
			0.2,
			0.5,
			0.3,
			1.1,
			0.4,
			1,
			1,
			0.3,
			0.4,
			0.3,
			0,
			0,
			0.2,
			0.1,
			0,
			0,
			0.1,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0.1,
			0.1,
			0.1,
			0,
			0,
			0,
			0.4,
			0.9,
			1.2,
			1.9,
			2.6,
			2.4,
			1.7,
			1.8,
			3.1,
			2.4,
			1.9,
			1.4,
			1.6,
			1.4,
			1.2,
			2.1,
			1.4,
			0.5,
			0.5,
			0.5,
			0.6,
			0.1,
			0.4,
			0.1,
			0.4,
			0.1,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0.1,
			0.2,
			0.5,
			0.1,
			0,
			0.1,
			0.2,
			0.1,
			0.2,
			0.2,
			0.4,
			0.6,
			0.3,
			1.5,
			1.7,
			1.3,
			1.2,
			0.9,
			1.5,
			3.5,
			1.4,
			0.7,
			0.6,
			0.8,
			1.4,
			0.6,
			0.9,
			0.9,
			0.9,
			0.8,
			0.8,
			0.8,
			0.8,
			0.8,
			0.8,
			0.6,
			0.6,
			0.6,
			1,
			1,
			1,
			1.2,
			1.2,
			1.2,
			0.5,
			0.5,
			0.5,
			0.4
		  ]
		}
	  }
	`

	mockResponse := &http.Response{
		StatusCode: 200,
		Body:       ioutil.NopCloser(bytes.NewBufferString(response)),
	}
	httpClient := &http.Client{Transport: &mockTransport{resp: mockResponse}}

	// Replace the default HTTP client with our mock client
	http.DefaultClient = httpClient

	// Call the getWeatherData function with a valid ZIP code
	err := w.getWeatherData("12345")
	if err != nil {
		t.Errorf("Unexpected error: %s", err)
	}

	// Check that the current temperature is correct
	expectedTemperature := 17.000000
	if w.CurrentWeather.Temperature != expectedTemperature {
		t.Errorf("Expected temperature to be %f, but got %f", expectedTemperature, w.CurrentWeather.Temperature)
	}

	var expectedTime int64 = 1683452400000
	if w.CurrentWeather.Time != expectedTime {
		t.Errorf("Expected time to be %d, but got %d", expectedTime, w.CurrentWeather.Time)
	}

}

type mockTransport struct {
	resp *http.Response
	err  error
}

func (t *mockTransport) RoundTrip(req *http.Request) (*http.Response, error) {
	return t.resp, t.err
}
